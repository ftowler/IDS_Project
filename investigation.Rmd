---
title: "Did the 2022 F1 Regulations Improve Racing as Intended"
author: "by Team-Name: Dimitri Rao, Fergus Towler, Eric Zhang, Moses Weintraub & Alan Zang"
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
# Add any other libraries here



```


```{r load-data}
circuits <- read_csv("data/circuits.csv")
constructor_results <- read_csv('data/constructor_results.csv')
constructor_standings <- read_csv('data/constructor_standings.csv')
constructors <- read_csv('data/constructors.csv')
driver_standings <- read_csv('data/driver_standings.csv')
drivers <- read_csv('data/drivers.csv')
lap_times <- read_csv('data/lap_times.csv')
pit_stops <- read_csv('data/pit_stops.csv')
qualifying <- read_csv('data/qualifying.csv')
races <- read_csv('data/races.csv')
results <- read_csv('data/results.csv')
seasons <- read_csv('data/seasons.csv')
sprint_results <- read_csv('data/sprint_results.csv')
status <- read_csv('data/status.csv')


```


``` {r Sum of Races Time Per Race}
results %>%
 # group_by(raceId) %>%
  arrange(raceId,positionOrder)%>%
  mutate(
  split_time =  if_else(.$positionOrder == 1 ,0,
                        if_else(.$positionOrder == "//N" ,0, as.integer(.$milliseconds) - lag(as.integer(.$milliseconds)))),
  season = case_when(
    .$raceId >= 1 & .$raceId <= 17 ~ "2009",
    .$raceId >= 337 & .$raceId <= 355 ~ "2010",
    .$raceId >= 841 & .$raceId <= 859 ~ "2011",
    .$raceId >= 860 & .$raceId <= 879 ~ "2012",
    .$raceId >= 880 & .$raceId <= 899 ~ "2013",
    .$raceId >= 900 & .$raceId <= 918 ~ "2014",
    .$raceId >= 926 & .$raceId <= 945 ~ "2015",
    .$raceId >= 948 & .$raceId <= 968 ~ "2016",
    .$raceId >= 969 & .$raceId <= 988 ~ "2017",
    .$raceId >= 989  & .$raceId <= 1009 ~ "2018",
    .$raceId >= 1010 & .$raceId <= 1030 ~ "2019",
    .$raceId >= 1031  & .$raceId <= 1047 ~ "2020",
    .$raceId >= 1052 & .$raceId <= 1073 ~ "2021",
    .$raceId >= 1074 & .$raceId <= 1096 ~ "2022"
  )
  )%>% group_by(.$season) %>% view() %>%
  ggplot() +
  geom_point(mapping = aes(x = season, y = mean(split_time, na.rm = TRUE)))

```

```{r Drivers and Constructors}
new_drivers<-subset(drivers,select=-c(driverRef,code,dob, nationality, url))
new_drivers1<-subset(new_drivers,select=-c(number)) 
new_constructors<-subset(constructors,select=-c(constructorRef,nationality,url))
driver_data <- merge(qualifying, new_drivers1, by = "driverId")
constructor_data <- merge(qualifying, new_constructors, by = "constructorId")
qualifying_data <- merge(constructor_data, driver_data, by = "qualifyId")
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "constructorId.x")]
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "raceId.x")]
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "driverId.x")]
 qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "number.x")]
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "position.x")]
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "q1.x")]
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "q2.x")]
qualifying_data <- qualifying_data[, -which(names(qualifying_data) == "q3.x")]
qd <- as.data.frame(qualifying_data)
colnames(qd) <- c("qualifyId", "name", "driverId", "raceId", "constructorId", "number", "position", "q1", "q2", "q3", "forename", "surname")
```

```{r constructor_points}
#Table with Constructor, Season, Total Points
constructor_results %>%
  filter(raceId >= 1, raceId <= 17) %>%
  group_by(constructorId) %>%
  summarise(total_points = sum(points))

```

```{r constructorPointsPerSeasonTable}
constructorPointsPerSeason<-left_join(constructors,constructor_results,by='constructorId')
season09<-constructorPointsPerSeason%>%
  filter(raceId>=1,raceId<=17)%>%
  group_by(name)%>%
  summarise(sum(points))
season10<-constructorPointsPerSeason%>%
  filter(raceId>=337,raceId<=355)%>%
  group_by(name)%>%
  summarise(sum(points))
season11<-constructorPointsPerSeason%>%
  filter(raceId>=841,raceId<=859)%>%
  group_by(name)%>%
  summarise(sum(points))
season12<-constructorPointsPerSeason%>%
  filter(raceId>=860,raceId<=879)%>%
  group_by(name)%>%
  summarise(sum(points))
season13<-constructorPointsPerSeason%>%
  filter(raceId>=880,raceId<=899)%>%
  group_by(name)%>%
  summarise(sum(points))
season14<-constructorPointsPerSeason%>%
  filter(raceId>=900,raceId<=918)%>%
  group_by(name)%>%
  summarise(sum(points))
season15<-constructorPointsPerSeason%>%
  filter(raceId>=926,raceId<=945)%>%
  group_by(name)%>%
  summarise(sum(points))
season16<-constructorPointsPerSeason%>%
  filter(raceId>=948,raceId<=968)%>%
  group_by(name)%>%
  summarise(sum(points))
season17<-constructorPointsPerSeason%>%
  filter(raceId>=969,raceId<=988)%>%
  group_by(name)%>%
  summarise(sum(points))
season18<-constructorPointsPerSeason%>%
  filter(raceId>=989,raceId<=1009)%>%
  group_by(name)%>%
  summarise(sum(points))
season19<-constructorPointsPerSeason%>%
  filter(raceId>=1010,raceId<=1030)%>%
  group_by(name)%>%
  summarise(sum(points))
season20<-constructorPointsPerSeason%>%
  filter(raceId>=1031,raceId<=1047)%>%
  group_by(name)%>%
  summarise(sum(points))
season21<-constructorPointsPerSeason%>%
  filter(raceId>=1052,raceId<=1073)%>%
  group_by(name)%>%
  summarise(sum(points))
season22<-constructorPointsPerSeason%>%
  filter(raceId>=1074,raceId<=1096)%>%
  group_by(name)%>%
  summarise(sum(points))
constructorPointsPerSeason<-full_join(season09,season10,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season11,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season12,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season13,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season14,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season15,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season16,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season17,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season18,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season19,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season20,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season21,by='name')
constructorPointsPerSeason<-full_join(constructorPointsPerSeason,season22,by='name')
constructorPointsPerSeason <- constructorPointsPerSeason %>%
  rename(
    Constructor_Name = name,
    `2009` = `sum(points).x`,
    `2010` = `sum(points).y`,
    `2011` = `sum(points).x.x`,
    `2012` = `sum(points).y.y`,
    `2013` = `sum(points).x.x.x`,
    `2014` = `sum(points).y.y.y`,
    `2015` = `sum(points).x.x.x.x`,
    `2016` = `sum(points).y.y.y.y`,
    `2017` = `sum(points).x.x.x.x.x`,
    `2018` = `sum(points).y.y.y.y.y`,
    `2019` = `sum(points).x.x.x.x.x.x`,
    `2020` = `sum(points).y.y.y.y.y.y`,    
    `2021` = `sum(points).x.x.x.x.x.x.x`,
    `2022` = `sum(points).y.y.y.y.y.y.y`
  )
```
```{r makingConstructorGraph}




temp<-constructorPointsPerSeason%>%
  summarise(
    '2009'=sd(`2009`,na.rm=TRUE),
    '2010'=sd(`2010`,na.rm=TRUE),
    '2011'=sd(`2011`,na.rm=TRUE),
    '2012'=sd(`2012`,na.rm=TRUE),
    '2013'=sd(`2013`,na.rm=TRUE),
    '2014'=sd(`2014`,na.rm=TRUE),
    '2015'=sd(`2015`,na.rm=TRUE),
    '2016'=sd(`2016`,na.rm=TRUE),
    '2017'=sd(`2017`,na.rm=TRUE),
    '2018'=sd(`2018`,na.rm=TRUE),
    '2019'=sd(`2019`,na.rm=TRUE),
    '2020'=sd(`2020`,na.rm=TRUE),
    '2021'=sd(`2021`,na.rm=TRUE),
    '2022'=sd(`2022`,na.rm=TRUE)
)%>%
  gather(key = "Season", value = "StandardDeviation")
ggplot(data=temp,aes(x = Season, y = StandardDeviation)) +
  geom_point() +
  geom_smooth(method=lm,se = FALSE, col = "blue")+
  labs(title = "Standard Deviation of points for Each Season", x = "Season", y = "Standard Deviation",subtitle = '2009-2022')


```



```{r driver championship}
driverPointsPerSeason<-left_join(drivers,results,by='driverId')
Season09 <- driverPointsPerSeason %>% #season09
  filter(raceId >= 1, raceId <= 17) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season10 <- driverPointsPerSeason %>% #season10
  filter(raceId >= 337, raceId <= 355) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season11 <- driverPointsPerSeason %>% #season11
  filter(raceId >= 841, raceId <= 859) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season12 <- driverPointsPerSeason %>% #season12
  filter(raceId >= 860, raceId <= 879) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season13 <- driverPointsPerSeason %>% #season13
  filter(raceId >= 880, raceId <= 899) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season14 <- driverPointsPerSeason %>% #season14
  filter(raceId >= 900, raceId <= 918) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season15 <- driverPointsPerSeason %>% #season15
  filter(raceId >= 926, raceId <= 945) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season16 <- driverPointsPerSeason %>% #season16
  filter(raceId >= 948, raceId <= 968) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season17 <- driverPointsPerSeason %>% #season17
  filter(raceId >= 969, raceId <= 988) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season18 <- driverPointsPerSeason %>% #season18
  filter(raceId >= 989, raceId <= 1009) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season19 <- driverPointsPerSeason %>% #season19
  filter(raceId >= 1010, raceId <= 1030) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season20 <- driverPointsPerSeason %>% #season20
  filter(raceId >= 1031, raceId <= 1047) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season21 <- driverPointsPerSeason %>% #season21
  filter(raceId >= 1052, raceId <= 1073) %>%
  group_by(driverId) %>%
  summarise(sum(points))
Season22 <- driverPointsPerSeason %>% #season22
  filter(raceId >= 1074, raceId <= 1096) %>%
  group_by(driverId) %>%
  summarise(sum(points))
driverPointsPerSeason<-full_join(Season09,Season10,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season11,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season12,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season13,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season14,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season15,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season16,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season17,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season18,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season19,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season20,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season21,by='driverId')
driverPointsPerSeason<-full_join(driverPointsPerSeason,Season22,by='driverId')
driverPointsPerSeason <-driverPointsPerSeason %>%
  rename(
    Driver_ID = driverId,
    `2009` = `sum(points).x`,
    `2010` = `sum(points).y`,
    `2011` = `sum(points).x.x`,
    `2012` = `sum(points).y.y`,
    `2013` = `sum(points).x.x.x`,
    `2014` = `sum(points).y.y.y`,
    `2015` = `sum(points).x.x.x.x`,
    `2016` = `sum(points).y.y.y.y`,
    `2017` = `sum(points).x.x.x.x.x`,
    `2018` = `sum(points).y.y.y.y.y`,
    `2019` = `sum(points).x.x.x.x.x.x`,
    `2020` = `sum(points).y.y.y.y.y.y`,    
    `2021` = `sum(points).x.x.x.x.x.x.x`,
    `2022` = `sum(points).y.y.y.y.y.y.y`
  )

```
```{r Standard diviation}
temp<-driverPointsPerSeason%>%
  summarise(
    '2009'=sd(`2009`,na.rm=TRUE),
    '2010'=sd(`2010`,na.rm=TRUE),
    '2011'=sd(`2011`,na.rm=TRUE),
    '2012'=sd(`2012`,na.rm=TRUE),
    '2013'=sd(`2013`,na.rm=TRUE),
    '2014'=sd(`2014`,na.rm=TRUE),
    '2015'=sd(`2015`,na.rm=TRUE),
    '2016'=sd(`2016`,na.rm=TRUE),
    '2017'=sd(`2017`,na.rm=TRUE),
    '2018'=sd(`2018`,na.rm=TRUE),
    '2019'=sd(`2019`,na.rm=TRUE),
    '2020'=sd(`2020`,na.rm=TRUE),
    '2021'=sd(`2021`,na.rm=TRUE),
    '2022'=sd(`2022`,na.rm=TRUE)
)%>%
  gather(key = "Season", value = "StandardDeviation")
ggplot(data=temp,aes(x = Season, y = StandardDeviation)) +
  geom_point() +
  geom_smooth(method=lm,se = FALSE, col = "red")+
  labs(title = "Driver Championship Standard Deviation of points for Each Season", x = "Season", y = "Standard Deviation",subtitle = '2009-2022')

```


```{r pit stop}
pit_stops %>%
  filter(raceId >= 841, raceId<= 858) %>%
  group_by(driverId) %>%
  summarise(avg_stop = mean(milliseconds)) 
```

``````{r qd}
qd <- qd %>% 
  filter(!(raceId >= 18 & raceId <= 336))
qd <- qd %>% 
  filter(!(raceId >= 356 & raceId <= 840))
qd <- qd %>% 
  filter(!(raceId >= 1097 & raceId <= 1110))
qd <- qd %>% 
  filter(!(raceId >= 1048 & raceId <= 1051))
qd <- qd %>% 
  filter(!(raceId >= 946 & raceId <= 947))
qd <- qd %>% 
  filter(!(raceId >= 919 & raceId <= 925))
qd <- qd %>% 
  filter(q3 != "\\N")
avg_quali <- qd_filter %>% 
  select(q3, raceId)
average_q3 <- avg_quali %>% 
  filter(raceId >= 1 & raceId <= 17)

```

